<!DOCTYPE html>
<html lang="en">

<head>
    <script src="./script.js"></script>
    <script type="module" src="upload.js"></script>

    <!-- <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script> -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.7.1.min.js"></script>


    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-EW58LBHFJP"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-EW58LBHFJP');
    </script>

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="../styles/styles.css">
    <link rel="stylesheet" href="../styles/portfolioStyles.css">
    <link rel="stylesheet" href="./visualattentionStyles.css">
    <link id="icon" rel="icon" href="" types="image/icon type">

    <title>
        Emotion Analysis Annotation Survey
    </title>

    <style>
        html {
            /* Prevent horizontal scrolling */
            overflow-x: hidden;
        }
    </style>
</head>

<body class="full">
    <p id="bottom">
        <!-- <a href="#" target="_blank">yourwebsite.com</a>&nbsp‚Ä¢&nbsp -->
        <a id="homelink"
            href="./">experiment</a></a>&nbsp‚Ä¢&nbsp<a id="homelink"
            href="./about/motivation">motivation</a></a>&nbsp‚Ä¢&nbsp<a id="homelink"
            href="./about/terms">terms</a>
        <!--<a id="homelink"
            href="./">experiment</a></a>&nbsp‚Ä¢&nbsp<a id="homelink"
            href="./about/motivation">motivation</a></a>&nbsp‚Ä¢&nbsp<a id="homelink"
            href="./about/terms">terms</a>&nbsp‚Ä¢&nbsp<a id="homelink" target="_blank"
            href="https://docs.google.com/forms/d/e/1FAIpQLScc99LZatY1LNPVE39fgy27ZGm_tKGOtn1TCeV8HdmB_TH6Aw/viewform">Participate in future experiments!</a>-->
        <a id="ictlogo" href="http://um.edu.mt/ict/ai" target="_blank"><img src="./ictlogo.png"></a>
    </p>

    <div id="game">

        <div id="cross"></div>
        <div id="trail"></div>

        <div id="imgcontainer">
            <!-- <img id="mainimage" src="" alt="">
            <h1 id="maintitle" src="" alt=""></h1> -->
            <!-- Emotion Radio Buttons (will be added dynamically using JavaScript) -->
            <!--<div id="emotion-selection" style="display: none; margin-top: 2em;">-->
            <!--<div id="emotion-selection" style="display: none;">
                <p><strong>Select the emotion that best matches the facial expression:</strong></p>
                <form id="emotion-form">
                    <label><input type="radio" name="emotion" value="happy"> Happy</label><br>
                    <label><input type="radio" name="emotion" value="sad"> Sad</label><br>
                    <label><input type="radio" name="emotion" value="neutral"> Neutral</label><br>
                    <label><input type="radio" name="emotion" value="angry"> Angry</label><br>
                    <label><input type="radio" name="emotion" value="fear"> Fear</label><br>
                    <label><input type="radio" name="emotion" value="surprise"> Surprise</label><br>
                    <label><input type="radio" name="emotion" value="disgust"> Disgust</label><br>
                </form>
                <button id="submit-emotion">Submit</button>
            </div>-->

        </div>

        <div id="disclaimer" style="text-align:center;">
            <p id="disclaimertext">This experiment is about how different people visualise and judge different facial expressions.
                <br><br>
                You will be provided the image of a person's facial region of interest (ROI).
                Your task is to select which emotion best suits the facial expression displayed by the person in the image.
                <br>
                <!--You have to choose ONLY 1 out of 7 predefined emotion categories (i.e. happy, sad, neutral, angry, fear, surprise, disgust).
                <br>-->
                The answer that you choose will be recorded.
                <br>
                <!-- <small>
                    <b>Apple phones are currently not supported...<br> Please check in tomorrow when a fix will be available. Sorry for any inconvenience.</b><br>
                </small> -->
                <!-- <small>If on mobile, tap and hold on the slider.</small> -->
            </p>
            <p id="agreeterms">
                <!-- Checkbox -->
                <input id="agree" type="checkbox" id="checkbox" name="checkbox" value="checkbox">
                <label for="agree" onclick="event.preventDefault();"></label>I agree to the <a
                    href="./about/terms">terms & conditions</a> of the
                experiment.</label>
            </p>

            <div class="buttonarea">
                <button id="start">
                    <p id="starttext">START</p>
                </button>
            </div>
        </div>

        <div id="infosubmission">
            <!-- Form which asks for age and gender -->
            <form id="infoform">
                <span>
                    <!-- <label for="age">Age:</label> -->
                    <input type="number" id="age" name="age" min="16" max="100" placeholder="Age" required>
                </span>
                <br>
                <span>
                    <!-- <label for="gender">Gender:</label> -->
                    <select id="gender" name="gender" required>
                        <option value="" disabled selected hidden>Gender</option>
                        <option value="Male">Male</option>
                        <option value="Female">Female</option>
                        <option value="Other">Other</option>
                        <option value="RatherNotSay">Rather not say</option>
                    </select>
                </span>

                <div class="buttonarea">
                    <button id="formsubmit">
                        <p id="submittext">SUBMIT</p>
                    </button>
                </div>
        </div>

        <div id="dogame">
            <div id="dot"></div>
            <p id="hovertext">
                Hover over the red dot
                <br>
                <br>
                <small>Your task is to hover where you are looking and <br>click on the part of the image which grabs
                    your attention the most</small>
            </p>
        </div>

        <div id="thankyou">
            <p id="thankyoutext">Thank you for your contribution! ‚ù§Ô∏è</p>
            <p id="didyouknow"><strong><i>Did you know?</i></strong></p>
            <p id="randomfact"></p>
            <button id="nextimage">
                <p id="nextimagetext">NEXT 5 FACES</p>
            </button>
            <p id="imagefraction"></p>
        </div>
    </div>

</body>


<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, listAll } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-storage.js";
    //import { firebaseConfig } from "./upload.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDk-q9iM_NXkP1oC81JDOLCS4Ts9YsMCGU",
        authDomain: "emotion-experiment-5f93a.firebaseapp.com",
        projectId: "emotion-experiment-5f93a",
        storageBucket: "emotion-experiment-5f93a.firebasestorage.app",
        messagingSenderId: "467284939414",
        appId: "1:467284939414:web:9a69ae0c7b31dd18f1e8b7"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app, "gs://emotion-experiment-5f93a.firebasestorage.app");

    let pid;
    let order;
    let imageCount = 0;
    let imgNum;
    let maxCount = 200;
    let titles = [];
    let facts = [];
    let age, gender, ip_address = "";

    //const emotionForm = document.getElementById("emotion-form");
    //const emotionSelection = document.getElementById("emotion-selection");
    //const submitEmotionBtn = document.getElementById("submit-emotion");

    function setPID(pid) {
        document.cookie = `pid=${pid}; expires=Thu, 31 Dec 2099 23:59:59 GMT; path=/`;
    }
    function setProgress(progress) {
        document.cookie = `progress=${progress}; expires=Thu, 31 Dec 2099 23:59:59 GMT; path=/`;
    }
    function setRandomisation(progress) {
        if (progress == 0) {
            let nums = Array.from({ length: maxCount }, (_, i) => i + 1);
            order = nums.sort(() => Math.random() - 0.5);
            document.cookie = `order=${order}; expires=Thu, 31 Dec 2099 23:59:59 GMT; path=/`;
        }
    }
    function getProgress() {
        const cookies = document.cookie.split('; ');
        for (const cookie of cookies) {
            const [name, value] = cookie.split('=');
            if (name === 'progress') return value;
        }
        return null;
    }
    function getPID() {
        const cookies = document.cookie.split('; ');
        for (const cookie of cookies) {
            const [name, value] = cookie.split('=');
            if (name === 'pid') return value;
        }
        return null;
    }
    function getOrder() {
        const cookies = document.cookie.split('; ');
        for (const cookie of cookies) {
            const [name, value] = cookie.split('=');
            if (name === 'order') return value.split(',').map(Number);
        }
        return null;
    }

    async function generatePID(age, gender, ip_address) {
        return new Promise((resolve, reject) => {
            const storageRef = ref(storage, 'pids/');
            let maxPID = 0;

            listAll(storageRef).then(res => {
                res.prefixes.forEach(prefix => {
                    const number = parseInt(prefix.name);
                    if (number > maxPID) maxPID = number;
                });

                const thisPID = maxPID + 1;
                const data = { age, gender, ip: ip_address };
                const file = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const fileName = 'info' + thisPID + '.json';
                const fileRef = ref(storage, 'pids/' + thisPID + '/' + fileName);

                uploadBytes(fileRef, file).then(() => resolve(thisPID)).catch(reject);
            }).catch(reject);
        });
    }

    const game = document.getElementById("game");
    const bottom = document.getElementById("bottom");
    const thankyou = document.getElementById("thankyou");
    const disclaimer = document.getElementById("disclaimer");
    const imgcontainer = document.getElementById("imgcontainer");
    const infosubmission = document.getElementById("infosubmission");

    start.style.pointerEvents = 'none';
    start.style.opacity = '0.3';

    // Check if #agree is checked, if yes allow START to be clicked, else no
    let agree = document.getElementById("agree");

    agree.addEventListener('change', () => {
        if (agree.checked) {
            start.style.pointerEvents = 'auto';
            start.style.opacity = '1';
        }

        else {
            start.style.pointerEvents = 'none';
            start.style.opacity = '0.3';
        }
    });


    async function initialiseGame() {
        infosubmission.style.display = "none";

        document.getElementById("infoform").removeEventListener('change', handleChange);

        if (imageCount == 0 && getPID() == null) {
            try {
                setRandomisation(0);
                const newPID = await generatePID(age, gender, ip_address);
                setPID(newPID);
                setProgress(imageCount);
                pid = newPID;
            } catch (error) {
                console.error("Error generating PID:", error);
                return;
            }
        } else {
            pid = getPID();
            order = getOrder();
            imageCount = parseInt(getProgress());

            console.log("CONTINUING PID: " + pid + " " + order);
            console.log("NUMBER OF IMAGES: " + order.length);
        }
        doGame();
    }

    function doDisclaimer() {
        disclaimer.style.display = "flex";
        thankyou.style.display = "none";

        const start = document.getElementById("start");
        const agree = document.getElementById("agree");
        let text = document.getElementById("disclaimertext");
        let startText = document.getElementById("starttext");

        let cookieProgress = parseInt(getProgress());

        if (cookieProgress == maxCount) {
            startText.innerHTML = "TEST COMPLETE";
            start.style.pointerEvents = 'none';
            start.style.opacity = '0.3';

            let terms = document.getElementById("agreeterms");
            terms.style.display = "none";
        }
        else if (cookieProgress > 0) {
            startText.innerHTML = "CONTINUE";
        }

        //start.style.pointerEvents = 'none';
        //start.style.opacity = '0.3';

        // On button hover, change the background color fade into white
        start.addEventListener('mouseenter', () => {
            start.style.backgroundColor = "#181818";
            startText.style.color = "#dfdfdf";
        });

        // On button hover, change the background color fade into white
        start.addEventListener('mouseleave', () => {
            start.style.backgroundColor = "#dfdfdf";
            startText.style.color = "#181818";
        });


        agree.addEventListener('change', () => {
            start.style.pointerEvents = agree.checked ? 'auto' : 'none';
            start.style.opacity = agree.checked ? '1' : '0.3';
        });

        start.addEventListener('click', () => {
            event.preventDefault();

            // Remove the text
            text.style.display = "none";
            start.style.display = "none";

            if (getPID() == null) {
                showForm();
            } else {
                initialiseGame();
            }
        });
    }

    function showForm() {
        let genderBox = document.getElementById("gender");

        genderBox.addEventListener('change', () => {
            genderBox.style.color = "#181818";
        });

        // On button hover, change the background color fade into white
        formsubmit.addEventListener('mouseenter', () => {
            formsubmit.style.backgroundColor = "#181818";
            submittext.style.color = "#dfdfdf";
        });

        // On button hover, change the background color fade into white
        formsubmit.addEventListener('mouseleave', () => {
            formsubmit.style.backgroundColor = "#dfdfdf";
            submittext.style.color = "#181818";
        });

        formsubmit.style.opacity = '0.3';
        formsubmit.style.pointerEvents = 'none';

        let infosubmission = document.getElementById("infosubmission");
        infosubmission.style.display = "flex";

        let disclaimer = document.getElementById("disclaimer");
        disclaimer.style.display = "none";

        document.getElementById("infoform").addEventListener('change', handleChange);
        document.getElementById("formsubmit").addEventListener('click', (e) => {
            e.preventDefault();
            age = document.getElementById("age").value;

            // Check if values are empty
            if (age == "") {
                alert("Please enter your age.");
                return;
            }

            initialiseGame();
        });
    }

    function handleChange() {
        age = document.getElementById("age").value;
        gender = document.getElementById("gender").value;
        const formsubmit = document.getElementById("formsubmit");
        formsubmit.style.pointerEvents = (age && gender) ? 'auto' : 'none';
        formsubmit.style.opacity = (age && gender) ? '1' : '0.3';
    }

    function doGame() {
        imgNum = order[imageCount];
        startGame();
    }

    function startGame() {
        console.log("startGame()");

        bottom.style.display = "none";

        disclaimer.style.display = "none";
        dogame.style.display = "none";

        // Clear previous image/title
        imgcontainer.innerHTML = '';

        // Create new image and title
        const img = document.createElement('img');
        img.setAttribute('id', 'mainimage');
        //img.src = './images/' + imgNum + '.jpg';
        img.src = './images_emo_new/' + imgNum + '.png';

        //const title = document.createElement('h1');
        //title.setAttribute('id', 'maintitle');
        //title.innerHTML = titles[imgNum - 1];

        // Alternate order of image and title
        /*if (imageCount % 2 === 0) {
            imgcontainer.appendChild(img);
            //imgcontainer.appendChild(title);
        } else {
            //imgcontainer.appendChild(title);
            imgcontainer.appendChild(img);
        }*/

        imgcontainer.appendChild(img);

        // üî• Create emotion-selection form dynamically
        const emotionDiv = document.createElement('div');
        emotionDiv.setAttribute('id', 'emotion-selection');
        emotionDiv.style.marginTop = '1em';
        emotionDiv.style.marginBottom = '1em';
        emotionDiv.style.textAlign = 'center';

        const prompt = document.createElement('p');
        prompt.innerHTML = '<strong>Select the emotion that best matches the facial expression in the image above:</strong>';
        emotionDiv.appendChild(prompt);

        const form = document.createElement('form');
        form.setAttribute('id', 'emotion-form');
        form.style.lineHeight = '1em';

        const emotions = ['happy', 'sad', 'neutral', 'angry', 'fear', 'surprise', 'disgust'];
        emotions.forEach(emotion => {
            const input = document.createElement('input');
            const emotionId = `emotion-${emotion}`;
            input.setAttribute('type', 'radio');
            input.setAttribute('name', 'emotion');
            input.setAttribute('value', emotion);
            input.setAttribute('id', emotionId);
            input.setAttribute('class', 'radio-input');

            const label = document.createElement('label');
            label.setAttribute('for', emotionId);
            label.setAttribute('class', 'radio-label');
            label.style.display = 'inline-block';
            //label.style.margin = '0.3em';
            label.style.cursor = 'pointer';
            label.textContent = emotion.charAt(0).toUpperCase() + emotion.slice(1);

            form.appendChild(input);
            form.appendChild(label);
        });

        //form.style.marginBottom = '3em';

        emotionDiv.appendChild(form);

        const submitBtn = document.createElement('button');
        submitBtn.setAttribute('id', 'submit-emotion');
        submitBtn.textContent = 'Submit';
        submitBtn.style.display = 'block';
        submitBtn.style.margin = '1.5em auto 0 auto';
        submitBtn.style.padding = '0.5em 1em';
        submitBtn.style.fontWeight = 'bold';
        submitBtn.disabled = true;

        emotionDiv.appendChild(submitBtn);
        imgcontainer.appendChild(emotionDiv);

        // Show image container
        img.style.display = "block";
        imgcontainer.style.display = 'flex';

        imgcontainer.style.opacity = 0;
        let opacity = 0;

        let fadeIn = setInterval(() => {
            if (opacity >= 1) {
                clearInterval(fadeIn);
            }
            else {
                opacity += 0.1;
                imgcontainer.style.opacity = opacity;
            }
        }, 50);

        // Show emotion selection
        const emotionSelection = document.getElementById('emotion-selection');
        const submitEmotionBtn = document.getElementById('submit-emotion');
        const emotionForm = document.getElementById('emotion-form');

        /*if (!emotionSelection || !submitEmotionBtn || !emotionForm) {
            console.error("One or more emotion elements are missing from the DOM.");
            return;
        }*/

        console.log("emotionSelection:", emotionSelection);

        emotionSelection.style.display = 'block';
        submitEmotionBtn.disabled = true;
        //emotionForm.style.marginBottom = '3em';

        // Reset any selected radio
        emotionForm.querySelectorAll('input[name="emotion"]').forEach(radio => {
            radio.checked = false;
            radio.addEventListener('change', () => {
                submitEmotionBtn.disabled = false;
            });
        });

        submitEmotionBtn.onclick = () => {
            const selected = emotionForm.querySelector('input[name="emotion"]:checked');
            if (selected) {
                //emotionSelection.style.display = 'none';
                imageCount++;
                setProgress(imageCount);
                endGame(selected.value);
            }
        };
    }


    function endGame(selectedEmotion) {
        const data = { selectedEmotion };
        const file = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const storageRef = ref(storage, 'pids/' + pid + '/responses/' + imgNum + '/');
        const fileRef = ref(storageRef, 'emotion' + pid + '.json');

        uploadBytes(fileRef, file).then(() => {
            setTimeout(thankYou, 500);
        }).catch(console.error);
    }

    function thankYou() {
        if (imageCount % 5 === 0) {
            thankyou.style.display = "flex";
            const imagefraction = document.getElementById("imagefraction");
            imagefraction.innerHTML = imageCount >= maxCount ? "TEST COMPLETE" : `${imageCount} / ${maxCount}`;
            imagefraction.style.display = "block";

            const nextButton = document.getElementById("nextimage");
            nextButton.style.display = imageCount < maxCount ? "flex" : "none";
            nextButton.onclick = () => {
                event.preventDefault();
                thankyou.style.display = "none";
                doGame();
            };

            const fact = getRandomFact();
            document.getElementById("randomfact").textContent = fact;
            //img.style.display = "none";
            imgcontainer.style.display = "none";
        } else {
            doGame();
        }
    }

    function getRandomFact() {
        const random = Math.floor(Math.random() * facts.length);
        return facts[random];
    }

    // Fetch titles and facts
    fetch('./titles.txt').then(res => res.text()).then(text => titles = text.trim().split('\n'));
    fetch('./facts_emotion.txt').then(res => res.text()).then(text => facts = text.trim().split('\n'));

    // Get IP address (optional)
    fetch('https://api.ipify.org?format=json')
        .then(response => response.json())
        .then(data => ip_address = data.ip)
        .catch(() => ip_address = "");

    imageCount = getProgress() == null ? 0 : parseInt(getProgress());
    order = getOrder();
    doDisclaimer();

</script>